### Техобслуживание: Очистка (VACUUM)

**Дата:** 2025-10-25 
**Семестр:** 4 курс 1 полугодие – 7 семестр  
**Группа:** ПИЖ-б-о-22-1  
**Дисциплина:** Администрирование баз данных  
**Студент:** Магомедов Ильяс Аскерович

## Цель работы
Всестороннее изучение механизмов очистки (VACUUM) в PostgreSQL. Получение практических навыков управления ручной и автоматической очисткой, анализа работы HOT-обновлений, исследования влияния очистки на размер таблиц и индексов, а также работы с заморозкой версий строк.

## Теоретическая часть
**Очистка (VACUUM):** Удаляет мертвые версии строк (кортежи), ставшие таковыми в результате UPDATE или DELETE. Освобождает место для повторного использования. Не уменьшает физический размер файла таблицы.

**Полная очистка (VACUUM FULL):** Перезаписывает файл таблицы, полностью удаляя мертвые кортежи и уплотняя данные. Уменьшает физический размер файла, но требует эксклюзивной блокировки.

**Автоочистка (AUTOVACUUM):** Фоновый процесс, автоматически выполняющий VACUUM для таблиц по мере накопления мертвых кортежей. HOT-обновления (Heap-Only Tuple): Специальный вид UPDATE, при котором новая версия строки помещается на ту же страницу, что и старая. Это позволяет избежать обновления индексов и повышает производительность.

**Заморозка (FREEZE):** Помечает версии строк как "замороженные", что позволяет предотвратить проблему оборачивания идентификаторов транзакций (XID).


### Модуль 1: Ручное очистка и ее влияние
#### Задача 1: Отключение автоочистки

``` sql
ALTER SYSTEM SET autovacuum = off;
SELECT pg_reload_conf();
SHOW autovacuum;
```

```
ALTER SYSTEM

 pg_reload_conf 
----------------
 t

| autovacuum |
|------------|
| off        |
SHOW 1
```

#### Задача 2: Подготовка данных
``` sql
CREATE TABLE vacuum_test (id INT);
CREATE INDEX idx_vacuum_test ON vacuum_test(id);
INSERT INTO vacuum_test 
SELECT (random() * 100000)::INT 
FROM generate_series(1, 100000);
SELECT 
    pg_size_pretty(pg_relation_size('vacuum_test')) as table_size,
    pg_size_pretty(pg_relation_size('idx_vacuum_test')) as index_size,
    pg_size_pretty(pg_total_relation_size('vacuum_test')) as total_size;
```

```
CREATE TABLE
CREATE INDEX
INSERT 0 100000

| table_size | index_size | total_size |
|------------+------------+------------|
| 3544 kB    | 2384 kB    | 5952 kB    |
(1 rows)

```


#### Задача 3: Наблюдение без очистки
``` sql
-- До обновлений
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
-- Обновление 1
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
-- Обновление 2
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
-- Обновление 3
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```

При UPDATE создается новая версия строки, а старая становится мертвым кортежем
Мертвые кортежи занимают место, но не видны в запросах

```
-- До обновлений
 pg_indexes_size 
-----------------
         2555904
(1 row)

 pg_total_relation_size 
------------------------
                6209536
(1 row)

-- Обновление 1
UPDATE 49981

 pg_indexes_size 
-----------------
4718592
(1 row)

 pg_total_relation_size 
------------------------
10182656
(1 row)

-- Обновление 2
UPDATE 50020

 pg_indexes_size 
-----------------
5046272
(1 row)

 pg_total_relation_size 
------------------------
11419648
(1 row)

-- Обновление 3
UPDATE 49966

 pg_indexes_size 
-----------------
7462912
(1 row)

 pg_total_relation_size 
------------------------
15056896
(1 row)
```
#### Задача 4: Полная очистка

 ``` sql
VACUUM FULL vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```

```
VACUUM

 pg_indexes_size 
-----------------
         2236416
(1 row)

 pg_total_relation_size 
------------------------
                5865472
(1 row)
```

#### Задача 5: Обычная очистка

``` sql
-- Обновление 1
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
-- Обновление 2
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
-- Обновление 3
UPDATE vacuum_test SET id = id + 1 WHERE random() < 0.5;
VACUUM vacuum_test;
SELECT pg_indexes_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```

```
UPDATE 49934

VACUUM

 pg_indexes_size 
-----------------
         4464640
(1 row)

 pg_total_relation_size 
------------------------
                9936896
(1 row)
```
#### Задача 6: Включение автоочистки
``` sql
ALTER SYSTEM RESET autovacuum;
SELECT pg_reload_conf();
SHOW autovacuum;
```

```
ALTER SYSTEM
 pg_reload_conf 
----------------
 t
(1 row)
```

### Модуль 2:  HOT-обновления и самоочистка
#### Задача 1: Самоочистка без HOT

``` sql
-- Создаем таблицу без индексов
CREATE TABLE no_hot (id INT, data TEXT, extra TEXT);
-- Вставляем тестовые данные
INSERT INTO no_hot
SELECT i, 'data_' || i, 'extra_' || i 
FROM generate_series(1, 100) i;
SELECT lp, t_xmin, t_xmax, t_ctid FROM heap_page_items(get_raw_page('no_hot', 0)) WHERE lp <= 10;
UPDATE no_hot SET data = 'updated_' || data WHERE id % 2 = 0;
SELECT lp, t_xmin, t_xmax, t_ctid FROM heap_page_items(get_raw_page('no_hot', 0)) WHERE lp <= 10;
CREATE INDEX idx_no_hot_data ON no_hot(data);
VACUUM no_hot;
SELECT lp, t_xmin, t_xmax, t_ctid FROM heap_page_items(get_raw_page('no_hot', 0)) WHERE lp <= 10;
```

```
CREATE TABLE
INSERT 0 100
| lp | t_xmin | t_xmax | t_ctid |
|----+--------+--------+--------|
| 1  | 900    | 0      | (0,1)  |
| 2  | 900    | 0      | (0,2)  |
| 3  | 900    | 0      | (0,3)  |
| 4  | 900    | 0      | (0,4)  |
| 5  | 900    | 0      | (0,5)  |
| 6  | 900    | 0      | (0,6)  |
| 7  | 900    | 0      | (0,7)  |
| 8  | 900    | 0      | (0,8)  |
| 9  | 900    | 0      | (0,9)  |
| 10 | 900    | 0      | (0,10) |
(10 rows)
UPDATE 50
| lp | t_xmin | t_xmax | t_ctid  |
|----+--------+--------+---------|
| 1  | 900    | 0      | (0,1)   |
| 2  | 900    | 901    | (0,101) |
| 3  | 900    | 0      | (0,3)   |
| 4  | 900    | 901    | (0,102) |
| 5  | 900    | 0      | (0,5)   |
| 6  | 900    | 901    | (0,103) |
| 7  | 900    | 0      | (0,7)   |
| 8  | 900    | 901    | (0,104) |
| 9  | 900    | 0      | (0,9)   |
| 10 | 900    | 901    | (0,105) |
(10 rows)
CREATE INDEX
VACUUM
| lp | t_xmin | t_xmax | t_ctid |
|----+--------+--------+--------|
| 1  | 900    | 0      | (0,1)  |
| 2  | <null> | <null> | <null> |
| 3  | 900    | 0      | (0,3)  |
| 4  | <null> | <null> | <null> |
| 5  | 900    | 0      | (0,5)  |
| 6  | <null> | <null> | <null> |
| 7  | 900    | 0      | (0,7)  |
| 8  | <null> | <null> | <null> |
| 9  | 900    | 0      | (0,9)  |
| 10 | <null> | <null> | <null> |
(10 rows)
```

#### Задача 2: HOT-обновление
``` sql
CREATE TABLE hot_test(id int, payload text);
CREATE INDEX hot_test_id_idx ON hot_test(id);
INSERT INTO hot_test VALUES (1, 'a');
UPDATE hot_test SET payload = payload || repeat('a', 50) WHERE id = 1;
SELECT lp, t_xmin, t_xmax, t_ctid FROM heap_page_items(get_raw_page('hot_test', 0));
SELECT itemoffset, ctid FROM bt_page_items('hot_test_id_idx', 1);
```

```
CREATE TABLE
CREATE INDEX
INSERT 0 1
UPDATE 1
 lp | t_xmin | t_xmax | t_ctid 
----+--------+--------+--------
  1 |    991 |    992 | (0,2)
  2 |    992 |      0 | (0,2)
(2 rows)

 itemoffset | ctid
------------+--------------
          1 | (0,1)
(1 row)
```

#### Задача 3: HOT-обновление с переносом
``` sql
CREATE TABLE hot_move(id int, payload text) WITH (fillfactor=100);
CREATE INDEX hot_move_id_idx ON hot_move(id);
INSERT INTO hot_move
SELECT 1, repeat('x', 300) FROM generate_series(1,25);
SELECT ctid FROM hot_move LIMIT 1; 
UPDATE hot_move
SET payload = repeat('y',10000)
WHERE ctid = '(0,1)';
SELECT ctid FROM hot_move WHERE id = 1 ORDER BY ctid LIMIT 10;

SELECT lp, lp_flags, t_xmin, t_xmax, t_ctid
FROM heap_page_items(get_raw_page('hot_move', 0))
ORDER BY lp;
SELECT itemoffset, ctid
FROM bt_page_items('hot_move_id_idx', 1); 
```

```
CREATE TABLE

CREATE INDEX

INSERT 0 25

 ctid  
-------
 (0,1)
(1 row)

UPDATE 1
  ctid  
--------
 (0,2)
 (0,3)
 (0,4)
 (0,5)
 (0,6)
 (0,7)
 (0,8)
 (0,9)
 (0,10)
 (0,11)
(10 rows)

 lp | lp_flags | t_xmin | t_xmax | t_ctid 
----+----------+--------+--------+--------
  1 |        3 |        |        | 
  2 |        1 |   1008 |      0 | (0,2)
  3 |        1 |   1008 |      0 | (0,3)
  4 |        1 |   1008 |      0 | (0,4)
  5 |        1 |   1008 |      0 | (0,5)
  6 |        1 |   1008 |      0 | (0,6)
  7 |        1 |   1008 |      0 | (0,7)
  8 |        1 |   1008 |      0 | (0,8)
  9 |        1 |   1008 |      0 | (0,9)
 10 |        1 |   1008 |      0 | (0,10)
 11 |        1 |   1008 |      0 | (0,11)
 12 |        1 |   1008 |      0 | (0,12)
 13 |        1 |   1008 |      0 | (0,13)
 14 |        1 |   1008 |      0 | (0,14)
 15 |        1 |   1008 |      0 | (0,15)
 16 |        1 |   1008 |      0 | (0,16)
 17 |        1 |   1008 |      0 | (0,17)
 18 |        1 |   1008 |      0 | (0,18)
 19 |        1 |   1008 |      0 | (0,19)
 20 |        1 |   1008 |      0 | (0,20)
 21 |        1 |   1008 |      0 | (0,21)
 22 |        1 |   1008 |      0 | (0,22)
 23 |        1 |   1008 |      0 | (0,23)
 24 |        1 |   1008 |      0 | (0,24)
(24 rows)

 itemoffset |  ctid  
------------+--------
          1 | (0,1)
          2 | (0,2)
          3 | (0,3)
          4 | (0,4)
          5 | (0,5)
          6 | (0,6)
          7 | (0,7)
          8 | (0,8)
          9 | (0,9)
         10 | (0,10)
         11 | (0,11)
         12 | (0,12)
         13 | (0,13)
         14 | (0,14)
         15 | (0,15)
         16 | (0,16)
         17 | (0,17)
         18 | (0,18)
         19 | (0,19)
         20 | (0,20)
         21 | (0,21)
         22 | (0,22)
         23 | (0,23)
         24 | (0,24)
         25 | (1,1)
         26 | (1,2)
(26 rows)
```

### Модуль 3:  Глубокая очистка и параметры
#### Задача 1: Многопроходная очистка индекса
``` sql
CREATE TABLE vacuum_test(id int, pad text);
CREATE INDEX vacuum_test_idx ON vacuum_test(id);
INSERT INTO vacuum_test
SELECT g, repeat('z', 100) FROM generate_series(1,1000000) g;
SET maintenance_work_mem = '1MB';
UPDATE vacuum_test SET pad = repeat('z',120) WHERE id % 2 = 0;
DELETE FROM vacuum_test WHERE id % 10 = 0;
VACUUM VERBOSE vacuum_test; 
```

```
CREATE TABLE

CREATE INDEX

INSERT 0 1000000

SET

UPDATE 500000

DELETE 100000

INFO:  vacuuming "lab04_db.public.vacuum_test"
INFO:  finished vacuuming "lab04_db.public.vacuum_test": index scans: 4
pages: 0 removed, 26857 remain, 26857 scanned (100.00% of total)
tuples: 100000 removed, 900000 remain, 0 are dead but not yet removable
removable cutoff: 1018, which was 0 XIDs old when operation ended
new relfrozenxid: 1015, which is 2 XIDs ahead of previous value
frozen: 0 pages from table (0.00% of total) had 0 tuples frozen
index scan needed: 26857 pages from table (100.00% of total) had 600000 dead item identifiers removed
index "vacuum_test_idx": pages: 5486 in total, 0 newly deleted, 0 currently deleted, 0 reusable
avg read rate: 340.087 MB/s, avg write rate: 173.720 MB/s
buffer usage: 62392 hits, 40152 misses, 20510 dirtied
WAL usage: 74267 records, 3 full page images, 7120684 bytes
system usage: CPU: user: 0.33 s, system: 0.30 s, elapsed: 0.92 s
INFO:  vacuuming "lab04_db.pg_toast.pg_toast_32903"
INFO:  finished vacuuming "lab04_db.pg_toast.pg_toast_32903": index scans: 0
pages: 0 removed, 0 remain, 0 scanned (100.00% of total)
tuples: 0 removed, 0 remain, 0 are dead but not yet removable
removable cutoff: 1018, which was 0 XIDs old when operation ended
new relfrozenxid: 1018, which is 5 XIDs ahead of previous value
frozen: 0 pages from table (100.00% of total) had 0 tuples frozen
index scan not needed: 0 pages from table (100.00% of total) had 0 dead item identifiers removed
avg read rate: 24.094 MB/s, avg write rate: 6.024 MB/s
buffer usage: 16 hits, 4 misses, 1 dirtied
WAL usage: 1 records, 0 full page images, 188 bytes
system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s
VACUUM
```

#### Задача 2: Обычная очистка после удаления
``` sql
DROP TABLE vacuum_test;
CREATE TABLE vacuum_test(id int, pad text);
CREATE INDEX vacuum_test_idx ON vacuum_test(id);
INSERT INTO vacuum_test
SELECT g, repeat('z', 100) FROM generate_series(1,1000000) g;
-- до удаления
SELECT pg_table_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
DELETE FROM vacuum_test WHERE random() < 0.9;
-- после удаления
SELECT pg_table_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
VACUUM vacuum_test;
-- после очистки
SELECT pg_table_size('vacuum_test');
SELECT pg_total_relation_size('vacuum_test');
```

```
DROP TABLE
CREATE TABLE
CREATE INDEX
INSERT 0 1000000
-- до удаления
 pg_table_size 
---------------
     141312000
(1 row)

 pg_total_relation_size 
------------------------
              163799040
(1 row)

DELETE 899836
-- после удаления
 pg_table_size 
---------------
     141312000
(1 row)

 pg_total_relation_size 
------------------------
              163799040
(1 row)

VACUUM
-- после очистки
 pg_table_size 
---------------
     141312000
(1 row)

 pg_total_relation_size 
------------------------
              163799040
(1 row)
```
#### Задача 3: Полная очистка после удаления
``` sql
DROP TABLE vacuum_test;
CREATE TABLE large_vacuum_test;
INSERT INTO large_vacuum_test 
SELECT i, 'data_' || i, rpad('x', 500, 'x')
FROM generate_series(1, 50000) i;
SELECT pg_size_pretty(pg_total_relation_size('large_vacuum_test')) as size_before_delete2
DELETE FROM large_vacuum_test WHERE random() < 0.9;
SELECT pg_size_pretty(pg_total_relation_size('large_vacuum_test')) as size_after_delete2;
VACUUM FULL large_vacuum_test;
SELECT pg_size_pretty(pg_total_relation_size('large_vacuum_test')) as size_after_vacuum_full;
```

```
TRUNCATE TABLE

INSERT 0 50000

+---------------------+
| size_before_delete2 |
|---------------------|
| 32 MB               |
+---------------------+
(1 row)

DELETE 44932

+--------------------+
| size_after_delete2 |
|--------------------|
| 32 MB              |
+--------------------+
(1 row)

VACUUM

+------------------------+
| size_after_vacuum_full |
|------------------------|
| 3208 kB                |
+------------------------+
(1 row)
```