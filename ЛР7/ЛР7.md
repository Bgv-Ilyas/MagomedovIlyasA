# Лабораторная работа №07: Управление доступом, расширениями и локализацией

**Дата:** 16.11.2025
**Семестр:** 4 курс 1 полугодие – 7 семестр  
**Группа:** ПИЖ-б-о-22-1    
**Дисциплина:** Администрирование баз данных  
**Студент:** Магомедов Ильяс Аскерович

## Цель работы  
Освоить управление правами доступа пользователей, работу с расширениями PostgreSQL и настройку параметров локализации. Получить практические навыки настройки аутентификации, управления привилегиями, установки расширений и миграции данных между разными кодировками.

## Теоретическая часть  
- **Управление доступом**: система ролей, привилегии, аутентификация через `pg_hba.conf`.  
- **Расширения**: установка дополнительного функционала (типы данных, функции, операторы).  
- **Локализация**: настройки кодировки, правил сортировки (`collation`), формата даты/времени.

## Практическая часть

### Модуль 1: Управление доступом
#### 1. Создание базы данных и пользователей 
```sql
CREATE DATABASE access_db;
CREATE ROLE writer WITH CREATEDB CREATEROLE LOGIN PASSWORD 'writer_pass';
CREATE ROLE reader WITH LOGIN PASSWORD 'reader_pass';
\c access_db
REVOKE ALL ON SCHEMA public FROM PUBLIC;
GRANT CREATE, USAGE ON SCHEMA public TO writer;
GRANT USAGE ON SCHEMA public TO reader;
-- Привилегии
ALTER DEFAULT PRIVILEGES FOR ROLE writer IN SCHEMA public
GRANT SELECT ON TABLES TO reader;
-- Пользователи
CREATE USER wl WITH PASSWORD 'wl_pass';
GRANT writer TO wl;
CREATE USER nl WITH PASSWORD 'nl_pass';
GRANT reader TO nl;
```
```
CREATE DATABASE
CREATE ROLE
CREATE ROLE
You are now connected to database "access_db" as user "postgres".
REVOKE
GRANT
GRANT
ALTER DEFAULT PRIVILEGES
CREATE ROLE
GRANT ROLE
CREATE ROLE
GRANT ROLE
```

#### 2. Аутентификация  

``` sql
CREATE ROLE alice LOGIN;
CREATE ROLE bob   LOGIN;
```

```
CREATE ROLE
CREATE ROLE;
```
`pg_hba.conf`:  
  ```
# TYPE  DATABASE        USER            ADDRESS                 METHOD
# "local" is for Unix domain socket connections only
local   all             postgres                                trust
local   all             student                                 trust
local   all             all                                     md5
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
# IPv6 local connections:
host    all             all             ::1/128                 md5
  ```  
```sql
SELECT pg_reload_conf();
```

```
Password for user alice: 
psql: error: connection to server on socket "/tmp/.s.PGSQL.5432" failed: fe_sendauth: no password supplied
```

Создание пользователя ОС и настройка `peer`-аутентификации.
``` sql
local all alice peer map=users_map
local all bob peer map=users_map
```

``` sql
SELECT pg_reload_conf();
CREATE DATABASE alice;
CREATE DATABASE bob;;
```
```
CREATE DATABASE
CREATE DATABASE
```

``` bash
sudo -u alice psql -U bob -d postgres
sudo -u alice psql -U charlie -d postgres
```

### Модуль 2: Управление расширениями

#### Задача 1 
```sql
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
SELECT * FROM pg_extension WHERE extname = 'pgcrypto';
```

```
 extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition 
---------+----------+--------------+----------------+------------+-----------+--------------
 pgcrypto|       10 |           2200 | t             | 1.3        |           | 
(1 row)
```

#### Задача 2 
```sql
SELECT extname, extversion, extconfig FROM pg_extension WHERE extname = 'pgcrypto';
\dx+ pgcrypto
```

```
 extname  | extversion | extconfig 
----------+------------+-----------
 pgcrypto | 1.3        | 
(1 row)

Objects in extension "pgcrypto"
     Object description      
-----------------------------
 function digest(bytea,text)
 function digest(text,text)
 function hmac(bytea,bytea,text)
 function hmac(text,text,text)
 function gen_random_bytes(integer)
 function gen_random_uuid()
 function crypt(text,text)
 function encrypt(bytea,bytea,text)
 function decrypt(bytea,bytea,text)
(9 rows)
```

#### Задача 3
```sql
CREATE ROLE crypto_user WITH LOGIN PASSWORD 'crypto_pass';
REVOKE EXECUTE ON ALL FUNCTIONS IN SCHEMA public FROM PUBLIC;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO crypto_user;
```
```
CREATE ROLE
REVOKE
GRANT
```

#### Задача 4 
```sql
\c postgres crypto_user
SELECT gen_random_uuid();
```

```
           gen_random_uuid           
--------------------------------------
 123e4567-e89b-12d3-a456-426614174000
(1 row)
```

#### Задача 5 
```bash
pg_dump -U postgres --schema-only --extension=pgcrypto postgres > pgcrypto_dump.sql
head -20 pgcrypto_dump.sql
```

```
PostgreSQL database dump

Dumped from database version 16.0
Dumped by pg_dump version 16.0

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;
Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: -

CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA public;
```

### Модуль 3: Локализация

#### 1. Миграция между кодировками  
```sql
CREATE DATABASE koi8r_db ENCODING 'KOI8R' LC_COLLATE 'ru_RU.KOI8-R' LC_CTYPE 'ru_RU.KOI8-R';
\c koi8r_db postgres
CREATE TABLE test_locale (id INT, text VARCHAR(100));
INSERT INTO test_locale VALUES (1, 'Привет, мир!'), (2, 'Тест кириллицы');
SELECT * FROM test_locale;
```

```
CREATE DATABASE
CREATE TABLE
INSERT 0 2
 id |       text        
----+-------------------
  1 | Привет, мир!
  2 | Тест кириллицы
(2 rows)
```

``` sql
CREATE DATABASE utf8_db ENCODING 'UTF8' LC_COLLATE 'ru_RU.UTF-8' LC_CTYPE 'ru_RU.UTF-8';
```

```bash
psql -U postgres -d utf8_db < koi8r_dump.sql
```

```
SET
SET
SET
SET
SET
SET
SET
SET
SET
CREATE TABLE
INSERT 0 2
```

``` sql
\c utf8_db postgres
SELECT * FROM test_locale;
```

```
 id |       text        
----+-------------------
  1 | Привет, мир!
  2 | Тест кириллицы
(2 rows)
```

#### 2. Локализация дат  
```sql
SELECT EXTRACT(DOW FROM CURRENT_DATE) AS day_of_week;
SHOW lc_time;
SET lc_time = 'ru_RU.UTF-8';
SELECT EXTRACT(DOW FROM CURRENT_DATE) AS day_of_week_ru;
```

```
 day_of_week 
-------------
           0
(1 row)

 lc_time  
----------
 C
(1 row)

SET
 day_of_week_ru 
----------------
              0
(1 row)
```


**Вывод:**  
Параметр `lc_time` влияет на форматирование даты и времени (например, названия дней и месяцев), но не влияет на логику вычисления номера дня недели с помощью `EXTRACT`.
## Выводы  
1. Освоены механизмы управления доступом в PostgreSQL: создание ролей, назначение привилегий, настройка аутентификации через `pg_hba.conf`.  
2. Получены навыки работы с расширениями: установка, исследование, управление доступом, резервное копирование.  
3. Изучены основы локализации: миграция между кодировками, настройка параметров сеанса.  
4. Все задания выполнены, результаты проверены и задокументированы.
