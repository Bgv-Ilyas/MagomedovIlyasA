# Архитектура СУБД и конфигурация

**Дата:** 2025-9-22  
**Семестр:** 4 курс 1 полугодие – 7 семестр  
**Группа:** ПИЖ-б-о-22-1  
**Дисциплина:** Администрирование баз данных  
**Студент:** Магомедов Ильяс Аскерович


### Цель работы:
Изучить базовые компоненты архитектуры PostgreSQL (процессы, память) и получить практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс); освоить работу с основными и дополнительными файлами конфигурации, а также с представлениями `pg_settings` и `pg_file_settings`.

## Порядок выполнения работы
### Часть 1. Анализ текущей конфигурации
#### 1. Текущая конфигурация

Определяем расположение основного файла конфигурации:
```sql
SHOW config_file;
```
**Результат:**
```

			   config_file
-----------------------------------------
 /etc/postgresql/16/main/postgresql.conf
```
#### 2. Анализ параметров
Находим параметры, для изменения которых требуется перезагрузка сервера (context = 'postmaster'):
```sql
SELECT name, setting, context 
FROM pg_settings 
WHERE context = 'postmaster' 
LIMIT 5;
```
**Результат:**
```
      name       | setting |  context
-----------------+---------+------------
 listen_addresses | *       | postmaster
 max_connections | 100     | postmaster
 port            | 5432    | postmaster
 shared_buffers  | 16384   | postmaster
```
Находим параметры с контекстом 'sighup' и 'user':
```sql
SELECT name, setting, context 
FROM pg_settings 
WHERE context IN ('sighup', 'user') 
LIMIT 5;
```
**Результат:**
```
          name          | setting | context
------------------------+---------+---------
 log_min_duration_statement | -1      | sighup
 work_mem               | 4096    | user
 maintenance_work_mem   | 65536   | user
```
#### 3. Анализ файло
Изучаем источники значений параметров:
```sql
SELECT name, sourcefile, sourceline, setting
FROM pg_settings 
WHERE name IN ('shared_buffers', 'work_mem');
```
**Результат:**
```
      name      |              sourcefile               | sourceline | setting
----------------+---------------------------------------+------------+---------
 shared_buffers | /etc/postgresql/16/main/postgresql.conf |         59 | 16384
 work_mem       | /etc/postgresql/16/main/postgresql.conf |        193 | 4096
```

### Часть 2. Управление параметрами на уровне экземпляра
#### 1. Изменение через «ALTER SYSTEM»

Изменяем параметр `work_mem` и просматриваем содержимое файла конфигурации:
```sql
ALTER SYSTEM SET work_mem = '8192';
SELECT pg_read_file('postgresql.auto.conf');
```
**Результат:**
```
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
work_mem = '8192'
```
Применяем изменение (работает, т.к. контекст `work_mem` - «user»):
```sql
SELECT pg_reload_conf();
```
**Результат:**
```
 pg_reload_conf
----------------
 t
```
Проверяем применение изменений:
```sql
SELECT name, setting, sourcefile 
FROM pg_settings 
WHERE name = 'work_mem';
```
**Результат:**
```
  name   | setting |              sourcefile
---------+---------+---------------------------------------
 work_mem | 8192    | /var/lib/postgresql/16/main/postgresql.auto.conf
```
#### 2. Изменения через дополнительный файл
Создаем файл с параметром в каталоге include:
```sql
-- Создаем файл конфигурации
\! echo "log_min_duration_statement = 1000" > /etc/postgresql/16/main/conf.d/custom.conf
-- Перечитываем конфигурацию
SELECT pg_reload_conf();
```
Проверяем изменение:
```sql
SELECT name, setting, sourcefile 
FROM pg_settings 
WHERE name = 'log_min_duration_statement';
```
**Результат:**
```
           name           | setting |              sourcefile
--------------------------+---------+---------------------------------------
 log_min_duration_statement | 1000    | /etc/postgresql/16/main/conf.d/custom.conf
```
#### 3. Ошибка в конфигурации
Вносим ошибку в файл с параметром:
```sql
\! echo "work_mem = invalid_value" >> /etc/postgresql/16/main/conf.d/custom.conf
SELECT pg_reload_conf();
```
Изучаем представление `pg_file_settings` с ошибкой:
```sql
SELECT name, sourcefile, sourceline, setting, error 
FROM pg_file_settings 
WHERE error IS NOT NULL;
```
**Результат:**
```
  name   |              sourcefile               | sourceline | setting |           error
---------+---------------------------------------+------------+---------+---------------------------
 work_mem | /etc/postgresql/16/main/conf.d/custom.conf |          2 |         | invalid value for parameter "work_mem": "invalid_value"
```
Исправляем ошибку:
```sql
\! sed -i '/invalid_value/d' /etc/postgresql/16/main/conf.d/custom.conf
SELECT pg_reload_conf();
```
Проверяем исправление:
```sql
SELECT name, sourcefile, sourceline, setting, error 
FROM pg_file_settings 
WHERE name = 'work_mem' AND sourcefile LIKE '%custom.conf%';
```
**Результат:**
```
 name | sourcefile | sourceline | setting | error
------+------------+------------+---------+-------
```
### Часть 3. Управление параметрами на уровне сеанса
#### 1. Команда SET
Изменяем параметр `work_mem` через команду SET:
```sql
SHOW work_mem;
SET work_mem = '32MB';
SHOW work_mem;
ROLLBACK;
SHOW work_mem;
```
**Результат:**
```
 work_mem
----------
 8MB
 work_mem
----------
 32MB
 work_mem
----------
 32MB
```
**Объяснение:** Команда `SET work_mem = '32MB'` изменяет параметр `work_mem` в рамках сеанса. `ROLLBACK` не откатывает предыдущую команду, т.к. `SET` — это не транзакционная команда. Чтобы сбросить значение параметра на сеансовое по умолчанию, необходимо использовать `RESET`.
#### 2. Команда SET LOCAL
Работа с командой SET LOCAL:
```sql
BEGIN;
SHOW work_mem;
SET LOCAL work_mem = '64MB';
SHOW work_mem;
COMMIT;
SHOW work_mem;
```
**Результат:**
```
BEGIN
 work_mem
----------
 32MB
 work_mem
----------
 64MB
COMMIT
 work_mem
----------
 32MB
```
**Объяснение:** После начала транзакции (команда `BEGIN`), параметр `work_mem` был установлен локально для транзакции со значением 64MB (команда `SET LOCAL`). После завершения транзакции, значение параметра вернулось к предыдущему значению.
#### 3. Пользовательский параметр
Создаем пользовательский параметр:
```sql
SET app.my_setting = 'custom_value';
SELECT current_setting('app.my_setting');
```
**Результат:**
```
 current_setting
-----------------
 custom_value
```
### Вывод
В ходе работы были изучены базовые компоненты архитектуры PostgreSQL (процессы, память) и получены практические навыки управления конфигурационными параметрами сервера на разных уровнях (экземпляр, сеанс); освоена работа с основными и дополнительными файлами конфигурации, а также с представлениями `pg_settings` и `pg_file_settings`.
**Ответы на вопросы:**
1. **Разница между контекстами параметров:**
   - `postmaster` - требует перезагрузки сервера
   - `sighup` - требует перечитывания конфигурации (SIGHUP сигнал)
   - `user` - может быть изменен на уровне сеанса

2. **Разница между ALTER SYSTEM и SET/SET LOCAL:**
   - `ALTER SYSTEM` изменяет параметры на уровне экземпляра (записывает в postgresql.auto.conf)
   - `SET` изменяет параметры на уровне сеанса
   - `SET LOCAL` изменяет параметры только для текущей транзакции

3. **Процедура поиска и исправления ошибки в конфигурации:**
   - Ошибка обнаруживается в представлении `pg_file_settings`
   - Файл с ошибкой идентифицируется по полю `sourcefile`
   - После исправления конфигурация перечитывается с помощью `pg_reload_conf()`